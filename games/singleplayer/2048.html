<html>
    <head>
        <meta charset="utf-8">
        <title>2048</title>
        <link href="../../main.css" rel="stylesheet" />
        <link href="2048.css" rel="stylesheet" />
        <script>
            let grid = Array(4).fill(Array(4).fill(null))

            function updateGrid() {
                grid.forEach((row, rowInd) => {
                    row.forEach((col, colInd) => {
                        const gridElem = document.getElementById(`sq${rowInd * 4 + colInd}`)
                        if (col !== null) {
                            gridElem.setAttribute('class', 'game-square occupied') 
                            gridElem.innerText = col
                        } else {
                            gridElem.setAttribute('class', 'game-square')
                            gridElem.innerText = '-'
                        }
                    })
                })
            }
            
            function addRandom() {
                const isAvailableSpace = checkAvailableGridSpaces()
                if (!isAvailableSpace) return
                else {
                    let randomRow = Math.floor(Math.random() * 4)
                    let randomCol = Math.floor(Math.random() * 4)
                    while (!!grid[randomRow][randomCol]) {
                        randomRow = Math.floor(Math.random() * 4)
                        randomCol = Math.floor(Math.random() * 4)
                    }
                    grid[randomRow] = grid[randomRow].map((elem, ind) => ind === randomCol ? 2 : elem)
                    updateGrid()
                }
            }

            function moveGridLeft() {
                grid.map(row => sortNumsL(row))
                updateGrid()
            }

            function moveGridRight() {
                grid.map(row => sortNumsR(row))
                updateGrid()
            }

            function moveGridDown() {
                for (let col = 0; col < 4; col++) {
                    let columnArr = []
                    for (let i = 0; i < 4; i++) {
                        columnArr.push(grid[i][col])
                    }
                    columnArr = sortNumsR(columnArr)
                    for (let i = 0; i < 4; i++) {
                        grid[i] = grid[i].map((elem, ind) => ind === col ? columnArr[i] : elem)
                    }
                }
                updateGrid()
            }

            function moveGridUp() {
                for (let col = 0; col < 4; col++) {
                    let columnArr = []
                    for (let i = 0; i < 4; i++) {
                        columnArr.push(grid[i][col])
                    }
                    columnArr = sortNumsL(columnArr)
                    for (let i = 0; i < 4; i++) {
                        grid[i] = grid[i].map((elem, ind) => ind === col ? columnArr[i] : elem)
                    }
                }
                updateGrid()
            }

            function sortNumsL(array) {
                array.sort((first, second) => {
                    if (first === null && second !== null) return 1
                    else if (first !== null && second === null) return -1
                    else return 0
                })
                array = mergeNumsL(array)
                return array            
            }

            function sortNumsR(array) {
                array.sort((first, second) => {
                    if (first === null && second !== null) return -1
                    else if (first !== null && second === null) return 1
                    else return 0
                })
                array = mergeNumsR(array)
                return array
            }

            function mergeNumsL(array) {
                for (let ind = 1; ind < array.length; ind++) {
                    if (array[ind] === null || array[ind - 1] === null) continue
                    else if (array[ind] === array[ind - 1]) {
                        array[ind - 1] = array[ind] * 2
                        array[ind] = null
                    }
                }
                return array
            }

            function mergeNumsR(array) {
                for (let ind = 1; ind < array.length; ind++) {
                    if (array[ind] === null || array[ind - 1] === null) continue
                    else if (array[ind] === array[ind - 1]) {
                        array[ind] = array[ind - 1] * 2
                        array[ind - 1] = null
                    }
                }
                return array
            }

            function checkAvailableGridSpaces() {
                return grid.flat().some(elem => elem === null)
            }

            function adjacentSquares(square) {
                let adjSquares = []
                const rowNum = square[0]
                const colNum = square[1]

                switch (rowNum) {
                    case 0:
                        if (colNum === 0) adjSquares = [[0, 1], [1, 0], [1, 1]]
                        else if (colNum === 3) adjSquares = [[0, 2], [1, 2], [1, 3]]
                        else adjSquares = [
                            [rowNum, colNum - 1], [rowNum, colNum + 1], [rowNum + 1, colNum]
                        ]
                        break
                    case 7:
                        if (colNum === 0) adjSquares = [[3, 1], [2, 1], [2, 2]]
                        else if (colNum === 3) adjSquares = [[3, 2], [2, 2], [2, 3]]
                        else adjSquares = [
                            [rowNum, colNum - 1], [rowNum, colNum + 1], [rowNum - 1, colNum]
                        ]
                        break
                    default:
                        adjSquares = [[rowNum - 1, colNum], [rowNum + 1, colNum]]
                        if (colNum !== 0) adjSquares.push([rowNum, colNum - 1])
                        if (colNum !== 3) adjSquares.push([rowNum, colNum + 1])
                        break
                }

                return adjSquares
            }

            function checkWinner() {
                if (1 > 3) {
                    // work on tomorrow
                } else if (grid.flat().some(num => num >= 2048)) {
                    document.getElementById('current').innerText = "Congratulations! You made 2048."
                    document.body.removeEventListener("keydown")
                    return true
                } else return false
            }
        </script>
    </head>
    <body>
        <script>
            document.body.addEventListener("keydown", (keyEvent) => {
                const keyPressed = keyEvent.code
                switch (keyPressed) {
                    case "ArrowLeft":
                    case "KeyA":
                        moveGridLeft()
                    case "ArrowRight":
                    case "KeyD":
                        moveGridRight()
                    case "ArrowDown":
                    case "KeyS":
                        moveGridDown()
                    case "ArrowUp":
                    case "KeyW":
                        moveGridUp()
                    default: 
                        addRandom()
                        break
                }
            })
        </script>
        <div class="header">
            <h1>2048</h1>
            <a href="../../homepage.html">Return to Home</a>
        </div>
        <hr>
        <p id="current">Use the arrow keys or WASD to move the numbers. Try to make 2048.</p>
        <div class="gamebox">
            <div class="row">
                <button class="game-square" id="sq0" disabled>-</button>
                <button class="game-square" id="sq1" disabled>-</button>
                <button class="game-square" id="sq2" disabled>-</button>
                <button class="game-square" id="sq3" disabled>-</button>
            </div>
            <div class="row">
                <button class="game-square" id="sq4" disabled>-</button>
                <button class="game-square" id="sq5" disabled>-</button>
                <button class="game-square" id="sq6" disabled>-</button>
                <button class="game-square" id="sq7" disabled>-</button>
            </div>
            <div class="row">
                <button class="game-square" id="sq8" disabled>-</button>
                <button class="game-square" id="sq9" disabled>-</button>
                <button class="game-square" id="sq10" disabled>-</button>
                <button class="game-square" id="sq11" disabled>-</button>
            </div>
            <div class="row">
                <button class="game-square" id="sq12" disabled>-</button>
                <button class="game-square" id="sq13" disabled>-</button>
                <button class="game-square" id="sq14" disabled>-</button>
                <button class="game-square" id="sq15" disabled>-</button>
            </div>
        </div>
    </body>
</html>